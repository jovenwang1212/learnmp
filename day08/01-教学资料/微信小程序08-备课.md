# 微信小程序学习第8天

1.  最后3天最后3天,好好学习,天天向上.<理解不难,最主要是要能都记下来真不简单

   1. 能理解就好。理解=听懂+动手敲。在理解的基础上，能动手查，然后

2.  快毕业了 好慌啊 

3. 带大家多熟悉一下文档

   

## 优购案例-搜索

#### 01.遗留问题

1. 输入框清空
   1. 父组件传参:query="keyword"
   2. onShow里面重置keyword=''
   3. 设置keyword

2. git查看修改的使用



## 优购案例-购物车

<img src="C:\Users\panliang\Desktop\learnmp\day08\01-教学资料\微信小程序08-备课.assets\3-购物车--cart.PNG" alt="3-购物车--cart" style="zoom:33%;" />

#### 01.页面分析

1. 商品详情点购物车，或者tabBar点购物车去到购物车页面
2. 去掉收货地址选择，一般收地址放在支付页面
3. 页面显示用户添加进购物车的商品列表，用户可选择商品，修改商品数量
4. 点结算去到支付页面

#### 02.静态页面

1. 标题设置
2. 购物车信息头部
3. 购物车信息列表
4. 底部信息

#### 03.基本逻辑

1. 商品详情点购物车跳转到购物车页面

   1. 事件@click:toCart
   
2. 切换到tab页wx.switchTab()
   
2. 商品详情页面，添加购物车，购物车数据存到storage,数据结构如下:
   
      ```js
      cart = {
        商品id: {
          num: 商品数量,
          checked:true
        }
      }
      ```

#### 04.请求数据&渲染数据

1. 根据商品ids请求商品详情，方法getGoodsList
   
   1. 接口 `/api/public/v1/goods/goodslist?goods_ids=${ids}`
   2. 在**onShow**请求
   3. 合并数据, 缓存数据和goodsList
   4. 样式调整
   5. iconfont引入
   
2. 商品数量修改

   1. -按钮最小值为1，1时disabled
   2. +按钮

3. 默认加载购物车是勾选的，商品的选中状态切换

   1. 商详添加购物车时，默认checked:true
   2. 购物车商品选中状态和商品列表数据合并
   3. checkbox的选中状态:class

4. 全选逻辑

   1. 所有商品选中时，触发全选选中状态;所有商品不选中时，去勾选全选
      1. every
   2. 选中全选，所有商品选中;去勾选全选，所有商品不选中。

5. 总数量显示

   1. reduce的用法

      ```js
      arr.reduce(function(上一次计算后的值，当前遍历中的元素)){
          return 上一次计算后的值与当前遍历中的元素的运算
      }，初始值)
      ```

6. 总价显示

7. 页面隐藏时onHide，保存cart状态到缓存



## 小程序授权

部分接口需要经过用户授权才能调用，比如说获取用户信息、通讯地址、微信运动步数

授权行为：

1. 第一次发起授权某权限，会弹窗请求权限，用户同意后会调用接口
   1. 发起授权
2. 如果用户已经授权，直接调用
3. 如果用户已经拒绝，直接进入失败。一般提示，同时打开设置

使用：

1. 



## 小程序登录

[传送门](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)

第三方登录：第三方网站授权登录

步骤：

1. 获取用户信息, 如果没有授权过，会在底部弹出授权窗口的

   ```html
   <button open-type="getUserInfo"
               bindgetuserinfo="getuserinfo">点我登录</button>
   ```

2. wx.getCode()获取到
3. 调后端接口获取token



>1. 这一小节我们来学习小程序的登录。我们在前面的课程里做过登录功能吧，我们一起回顾一下token登录。用户输入用户名和密码，发送登录请求，服务器验证用户名和密码通过，返回成功并附上token发给浏览器。后续需要登陆的请求我们就需在header里面带上token对吗？
>2. 再说一个概念，第三方登陆。什么是第三方登陆呢？比如我们打开掘金这个App，如果我们没有账号，注册账号需要填写一堆信息是吧。别慌，看看下边，有一个微信图标，这是什么，微信授权登录。点击微信，会去到授权页面，点击授权，即可完成注册。当然我这里已经注册过，我点微信，直接登陆了。这个就是第三方登录。第三方是什么？相对于掘金来说，微信，微博和github都是第三方网站。那么第三方登录的意思就是，第三方网站授权登录。
>3. 那么第三方登录其中发生了什么呢？微信登录完，授权给了掘金微信用户的个人信息和用户标识，在掘金的后台生成token，发给用户前端。其实跟我们做过的token登录是一样的。那么如何生成token用得着我们前端关心吗？不用。
>4. 再回头说说小程序登录，我们小程序就是运行在微信里面，那在小程序里面最常见的登录方式就是微信授权登录了。
>5. 我们看到官方图示， 这个图内容挺多的时候，不要害怕。这个开发者服务器就是我们的后端服务器。首先前端发送code到自己的服务器，服务器再用code+appid+appsecret发到微信服务器，服务器返回session_key，后端服务器拿到session_key加密，就是token，然后发送到前端。我们只需要明白，前端发一个code给后端，后端返回一个token。
>6. 其实看到我们的步骤。并不完整。文档没更新。我演示一下真正的步骤。



## 优购案例-登录

#### 01.页面分析

1. 购物车页面点结算，如果未登录，跳转登录，否则跳转支付页面
2. 登录页上，点立即登录，登录成功，goBack

#### 02.基本逻辑

1. 购物车点结算，当然如果没有选择商品就提示;未登录跳转登录; 否则跳转支付页面，
   1. 是否登录判断token
2. 登录页，立即登录
   1. getUserInfo+code，调登录接口
   2. 存储token并back



## 小程序支付

## 优购案例-支付

![1573044092959](C:\Users\panliang\Desktop\learnmp\day08\01-教学资料\微信小程序08-备课.assets\1573044092959.png)

#### 01.页面分析

1. 购物车点结算，或者商品详情点立即购买去到支付页面
2. 支付页面展示收货地址选择以及需要确定购买的商品列表（不能去选中及修改数量, 没有勾选）
3. 点击微信支付，生成订单，再微信支付
4. 支付成功或者失败进入订单结果页

#### 02.静态页面

1. 新建支付页面pay
2. 收货地址和选择收货地址
3. 收货地址边框
4. 商品列表copy，修改部分
5. 微信支付按钮，及订单信息

#### 03.基本逻辑

1. 商品详情点结算跳转支付页面

2. 点击请选择地址，选择微信地址，选择地址确定，获取地址，显示地址
   1. 微信，我->头像->我的地址，里面有微信的收货地址，这里同步微信的收货地址
   2. 点击请求选择地址@click="getAddress"
   3. 获取微信收货地址 wx.chooseAddress成功回调里获取
   
3. 获取到收货地址后，缓存到本地; 页面初始化时从缓存中读取

   

#### 04.请求数据&渲染数据

1. 根据商品ids请求商品详情,**渲染购物车选中的商品**，方法getGoodsList
   
   1. 接口 `/api/public/v1/goods/goodslist?goods_ids=${ids}`
   
2. 点击微信支付先生成订单

   1. 判断是否有商品，是否选择了地址

   2. 接口/api/public/v1/my/orders/create

      1. method:POST

      2. 请求头 "Authorization" : token

      3. data:{

         order_price 订单价格

         consignee_addr 订单地址

         goods 商品列表内部存放商品对象（goods_id，goods_number和goods_price）}

      3. 不论成功或者失败，都从购物车里面清掉checked商品

3. 生成订单成功后，生成预支付交易单
   1. 接口/api/public/v1/my/orders/req_unifiedorder
      1. method:POST
      2. 请求头 "Authorization" : token
      3. 请求体:
           order_number : 订单号
   
4. 生成订单后，调用wx.requestPayment





## mpvue坑点

1. 新增页面需要重新npm run start
2. 嵌套v-for索引别名不要相同，双层嵌套v-for需要取不同索引别名
3. v-html指令大部分HMTL不能解析，能解析img标签
4. 过滤器无法使用
5. 指令不支持方法，常见的{{}}里面不支持方法
6. 指令里面不支持字符串的模板语法
7. mpvue的app.json最好用根路径，以`/`打头
8. v-model指令不支持checkbox
9. **页面销毁，对应的Vue实例还在，需要手动重置数据**
10. 父传子，子组件里面可以直接改props，且不会影响父值
11. 经常有源码目录和dist目录不同步的问题，需要手动删除wx/dist重启