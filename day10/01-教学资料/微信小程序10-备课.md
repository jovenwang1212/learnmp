# 微信小程序学习第10天

## 每日反馈

1.  是的，最后一次写评论了，也是最后一次上课了，以后可能再也不会踏上课堂学习了，在黑马，弥补了自己在大学懒惰荒废的学习时光，原来自己的意志与信念是如此强大，学到的不只是技术，更是灵魂上的升华，感谢强大的自己没有继续去沉沦，感谢这半年来各位老师的教导，感谢我遇到的你，同学们，精彩的人生才刚开始，与君共勉！ 
2.  请求中 get 和 post 有什么区别? 
    1. get请求参数是放在header里面
       1. 如果用浏览器访问的话，可以看参数就在url上
       2. 可以在浏览器上直接访问get接口，用来测试接口
    2. post请求参数是放在body
    3. RestFul
       1.  GET用来获取资源，POST用来新建资源（也可以用于更新资源），PUT用来更新资源，DELETE用来删除资源； 
3.  真棒 
4.  Vysor用来把安卓手机投屏到电脑





## uni-app的工程结构

极像mpvue生成的工程结构

![1573229589367](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1573229589367.png)

1. pages.json配置路由，导航条和Tab栏等，小程序app.json的页面管理部分
2. manifest.json包括app.json的非页面管理部分
3. 页面直接是.vue文件，页面的配置在pages.json里面

> 总的来说，工程结构和mpvue非常像，其实它也是nodejs+webpack的工程，只不过隐藏一些文件。



## uni-app的语法

[组件](https://uniapp.dcloud.io/component/README)

语法和mpvue非常类似

1. 组件和标签的变化
   1. div改成view，都行
   2. span改成text，都行
   3. a改成navigator，都行
      1. a最好不要使用，因为不能配合属性href
   4. img改成image，都行
   5. select改成picker
   6. ul和li用view替代，能用
   7. input,button,checkbox能用
2. 其他组件基本和小程序的一致

3. wx对象换成uni对象，但是wx依然能用
4. css的变化
   1. 使用rpx和px单位
   2. flex布局

> mpvue可以使用小程序的组件，wx对象，可以用vue自身的语法
>
> **如果按规范来写的话，兼容是最好的**
>
> 如果想用less的话，需要安装插件，工具->插件配置->找到less安装



## mpvue-yougou迁移到uni-app

#### 01.初步工作

1.  HBuilderX里新建**默认模板的uni-app**项目 `uni-yougou`
2.  src目录下的文件全部copy覆盖uni-yougou根目录
3.  在pages.json里面设置home页面的路径
    1. 工具-插件 安装less支持
4.  在pages.json里面设置home的标题，清除home路径下的main.json和main.js
5.  pages.json设置全局样式
6.  一些文件引入路径需要调整



注意点：

1. 建议用微信开发者工具调试或者内置浏览器

   1. 设置-安全设置-开启

2. 外部浏览器打开的url是本地server，跨域

3. 真机报错信息不充分

   

#### 02.显示四个tab页面

1. copy覆盖static目录到uni-yougou的根目录下

2. 在pages里面设置tabBar
3. 修改pages里面的页面路径，删除无用main.json和main.js
4. 修改图片路径错误，组件路径问题

> '/'表示当前项目的根目录
>
> // TODO @import的问题

 

#### 03.剩余工作

1. 建议页面下的文件名为main.vue，否则js里面路转路径得改。
   1. 为了只改配置不改代码
2. pages.json里面配置页面路径，修改对应页面index.vue为main.vue，删除main.json和main.js
3. 删除掉app.json和uni.scss
4. 真机运行，并打包apk，安装
5. 发行H5，并运行

注意：

1. 搜索列表页面配置上拉加载和下拉刷新

> 1. @click="不能在行内写逻辑"
>
> 2. 分享用uni.share



#### 04.bug修复

1. vuex store cart的初始值的问题



## Fiddler简介

[传送门](https://www.telerik.com/fiddler)

Filddler是代理服务器，用于web调试。

1. 安装，下载后常规安装

2. 工作原理，请求先发送到Fiddler，然后Fiddler帮我们把请求发给服务器
3. 作用：查看请求，伪造请求，测试网站的性能

![1574343877050](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574343877050.png)



## Fiddler使用

1. 基本使用，选择请求，查看请求详细信息

2. fiddler抓包chrome   https://blog.csdn.net/lone1013/article/details/81222556 

   1. 再chrome导入证书

   ![1574405182271](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574405182271.png)

   ![1574405210912](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574405210912.png)

   

3. fiddler抓包手机端

   1. 安卓  https://www.jianshu.com/p/724097741bdf 
   2. ios  https://www.jianshu.com/p/724097741bdf 
   3. 大致的步骤
      1. filddler所在的电脑和手机在同一个局域网内
      2. 在手机上访问 `电脑ip:8888`可以下载证书
      3. 手机上安装证书
      4. 手机wifi设置代理为电脑ip：8888

4. 请求模拟

   1. 请求伪造，让访问本地文件

5. 线上bug调试

   1. 请求伪造，让访问本地文件

6. 网络限速



## 大公司里怎样开发和部署前端代码？

[传送门]( https://www.zhihu.com/question/20790576/answer/32602154 )

1. 页面index.html包含a.css，无缓存
   1. 每次用户访问页面都要从服务器加载

![1574341646483](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574341646483.png)



![1574341667795](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574341667795.png)

2. a.css使用缓存器缓存，协商缓存，询问服务器缓存有没有过期

   1. 还是需要请求服务器一次

   ![1574342116120](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574342116120.png)

3. 静态资源内容变更都更新hash,从浏览器取缓存;入口文件协商缓存

   ![1574342526892](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574342526892.png)

## HTTP缓存

概念： 浏览器请求某资源（html,js,css,图片等）时，如果浏览器有资源副本，就可以直接从浏览器缓存中获取，不用从服务器获取。
作用：节省流量，提高用户体验



#### 强制缓存

即浏览器直接使用缓存

![1574339305388](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574339305388.png)

1. 一般设置 cache-control里面的max-age为一个长时间，单位为秒
2. 一般静态资源都用强缓存



#### 协商缓存

浏览器缓存数据和数据的标识，下一次请求发送缓存标识给服务器，确定缓存数据有没有改动。如果没有改动，返回304，取缓存数据; 如果有改动，服务器发送请求的数据和新的标识。

![1574340034003](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574340034003.png)



1. 数据的标识有两种

   1. 修改时间 If-Modified-Since和Last-Modified

   2. Etag 根据文件内容或者摘要生成 If-None-Match和etag

      

#### 总结

1. 入口文件设置协商缓存

2. 静态资源设置强缓存，cache-control里面的max-age设置时间长一些。

3. 一般对HTTP缓存的设置是由运维或者后端来设置的，但是前端需要了解这些边界问题

   

![1574341185114](C:\Users\panliang\Desktop\learnmp\day10\01-教学资料\微信小程序10-备课.assets\1574341185114.png)



## 小程序组件基本使用

[传送门](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/)

声明组件，基本和页面没啥区别

1. 结构
2. 样式
3. 逻辑
   1. **方法写在methods里面**

使用组件

1. 引入

   1. // 组件名:组件路径

      ```json
      {
        "usingComponents": {
          "counter":"/components/counter"
        }
      }
      ```

2. 使用

   1. 当标签使用即可。

   

## 小程序组件父子组件通信

1. 父传子

   1. 在父组件中的子组件标签添加属性，给子组件传递数据 

      ```
       <submit-bar totalMoney="{{totalMoney}}" ></submit-bar>
      ```

   2. 子组件在js中通过properties接收，可以指定接收数据类型

      ```js
       properties: {
           totalMoney: Number
       }
      ```

2. 子传父

   1. 在父组件的子组件标签自定义事件，传给子组件

      ```html
       <submit-bar  bind:submit="submit" ></submit-bar>
      ```

   2. 子组件用`this.triggerEvent('父组件自定义事件', '要传递的参数')`，触发父组件传过来的自定义事件 

      ```
       this.triggerEvent("submit", 'Hello Grayly')
      ```

   3. 第二步执行后，父组件自定义事件绑定的函数就会执行，同时接受子组件传过来的数据
      （在event.detail中可得到子组件传过来的参数） 

      ```
      submit(event) {
      	console.log(event);
      },
      ```

      

## 小程序云开发简介

小程序的后端服务器，帮助开发者快速搭建后端服务。开发语言是Node.js

提供的功能：

1. 云函数
   1. 获取appid等鉴权信息
   2. 更容易完成登录和支付
2. 云数据库
   1. mangodb
   2. 数据的增删改查
3. 云存储
   1. 管理文件

特点：

1. 不管考虑服务器，运维，域名等等
2. 免费2GB数据库和5GB的文件存储
3. 开发简单

原理：SeverLess无服务

	1. 不太需要维护的,可扩展的服务

   	2. 让开发者只需要关注自己的业务逻辑就行



## 小程序云开发开通

1. 新建项目云开发
   1. 不能使用测试账号
2. 微信开发者工具上点击云开发，确定 
3. 新建环境
   1. 每个小程序账号可以免费创建两个环境，建议开发环境(测试环境)和生产环境
   2. 基础版是免费的，完全可以满足开发

4. 云开发控制台
   1. 运营分析
   2. 可以再创建一个环境

5. miniprogram是前端代码，cloudfunctions是云后台代码



## 云数据库

[传送门](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/capabilities.html#%E6%95%B0%E6%8D%AE%E5%BA%93)

​	云开发提供了一个JSON数据库（mongoDB），提供2GB免费存储空间。

集合里面每条记录都是一个JSON格式的对象，可以理解为一个JSON数组

使用方法：

1. 创建一个集合`user`，添加记录

   1. 导出，可以看到JSON数据集合

2. 插入一行

   1. 返回_id是唯一标识

   ```js
   db.collection('user').add({
       data: {
           name: 'Joven2',
           age: 28
       }
   }).then(res=>{
       console.log(res)
   })
   ```

3. 查找

   1. 查找某一行记录
   2. 查找多个记录

   ```js
   db.collection('user').doc('953037125dd725ef01fdb3fa34a391d0').get().then(res=>{
       console.log(res)
   })
   
   db.collection('user').where({
       name: 'Joven1'
   }).get().then(res=>{
       console.log(res)
   })
   ```

4. 更新一行

   1. doc后面指定是_id

   ```js
   updateRow(){
       db.collection('user').doc('953037125dd725ef01fdb3fa34a391d0').update({
           data:{
               age: 100
           }
       }).then(res=>{
           console.log(res)
       })
   },
   ```

5. 手动插入的数据没有_openid，权限的作用

6. 删除一行

   ```js
   db.collection('user').doc('953037125dd725ef01fdb3fa34a391d0').
       remove().then(res=>{
         console.log(res)
       })
   ```

> 给前端操作数据库的逻辑



## 云函数

小程序运行的后端代码。

1. 安装Nodejs环境

2. 新建云函数sum,在index.js

   ```js
   exports.main = async (event, context) => {
    return{
      sum:event.a+event.b
    }
   }
   ```

3. 在小程序前端的代码里面

   ```js
   wx.cloud.callFunction({
       name:'sum',
       data:{
           a:2,
           b:3
       }
   }).then(res=>{
       console.log(res.result.sum)
   })
   ```

4. 调用login，获取登录信息



## 云存储

免费5GB的存储空间

一般用于存储图片

```JS
wx.cloud.uploadFile({
    cloudPath:'example.png',
    filePath:tempFilePaths[0],
}).then(res=>{
    // console.log(res)
})
```

