# 微信小程序学习第9天



## 优购案例-优化

#### 01.支付页面-收货地址用户拒绝授权后提示

​	   1. 首次请求权限

   	2. 如果允许的话，可以调接口获取相应的授权数据

   	3.如果拒绝，没有反应。需要引导打开设置，允许

#### 02.商品详情-立即购买跳转支付页面

 	1. 商详页面传递goodsId
 	2. 支付页面，展示立即购买的那个商品，数量为1
      	3. 生成订单，不需要整理cart

#### 03.设置购物车的商品个数

	1. wx.setTabBarBadge

#### 04.request中设置token

1. isAuth为true是添加token



## 优购案例-订单结果页

![1573044202962](C:\Users\panliang\Desktop\learnmp\day09\01-教学资料\微信小程序09-备课.assets\1573044202962.png)

#### 01.页面分析

1. 支付页面，支付取消或者支付成功，都会进入订单结果页

2. 订单结果页支付成功，展示成功状态和首页按钮，点首页按钮去到首页
3. 订单结果页支付失败，展示失败状态和首页按钮与订单详情按钮，点首页按钮去到首页，点订单详情去到订单详情

#### 02.静态页面

1. 文案及两个按钮

#### 03.基本逻辑

1. 支付页面上，支付成功和失败跳转订单结果页
2. 支付成功显示`首页`
3. 支付失败显示`首页`和`查询订单详情`



## 优购案例-订单详情

![1573045790457](C:\Users\panliang\Desktop\learnmp\day09\01-教学资料\微信小程序09-备课.assets\1573045790457.png)

#### 01.页面分析

1. 订单结果点订单详情去到订单详情
2. 订单详情展示订单基本信息

#### 02.静态页面

1. 展示订单基本信息

#### 03.请求&渲染数据

1. 未登录跳转登录

2. 查询订单状态

   1. 接口 /api/public/v1/my/orders/chkOrder

      1. 请求方式POST

      2. 请求头:

          "Authorization" : token // 需要设置token带给后台

      3. 请求体:
           order_number : 订单号



## 优购案例-我的

<img src="C:\Users\panliang\Desktop\learnmp\day09\01-教学资料\微信小程序09-备课.assets\4-我的--my.PNG" alt="4-我的--my" style="zoom:33%;" />

#### 01.页面分析

1. 入口是tabBar
2. 展示登录状态收藏店铺、订单及其他信息
3. 已经登录展示用户头像和昵称，未登陆就显示登录，点登录跳转登录
4. 点订单跳转订单列表

#### 02.静态页面

#### 03.基本逻辑

1. 已经登录展示用户头像和昵称，未登陆就显示登录，点登录跳转登录
   1. login页userInfo添加到storage
   2. onShow里面获取到用户信息
2. 拨打电话
   1. wx.makePhoneCall





## 优购案例-订单列表

<img src="C:\Users\panliang\Desktop\learnmp\day09\01-教学资料\微信小程序09-备课.assets\6-订单列表--orders.PNG" alt="6-订单列表--orders" style="zoom:33%;" />

#### 01.页面分析

1. 分别展示全部，待付款，已付款，退款/退货的订单列表
2. 在我的页面，点击订单去到订单列表
3. 点击订单列表其中一项，去到订单详情
4. 待支付的订单，点支付可以完成支付

#### 02.静态页面

1. 顶部tab栏
2. 订单列表展示

#### 03.基本逻辑

1. 我的页面点击不同菜单去到订单列表，选中对应的tab
   1. 两边菜单并不是一一对应的，设置数组序列标志
2. 点击tab展示对应的列表

#### 04.请求&渲染数据

2. 渲染订单列表

   1. 接口`/api/public/v1/my/orders/all?type=1`

      1. 请求方式GET

      2. 请求头:

          "Authorization" : token //需要设置token带给后台

2. 切换Tab发送请求

   

注意点：

1. 在调试器的AppData里查看数据，绿色就是字符串类型，红色是数字类型

![1573185704630](C:\Users\panliang\Desktop\learnmp\day09\01-教学资料\微信小程序09-备课.assets\1573185704630.png)



## mpvue与Vuex的结合

vuex就是一个全局变量，存储整个所有组件的状态。

先是由React, 先是提了Flux规范，然后Redux实现了它。

> 由于全局变量太灵活，vuex定义了一个操作全局变量的规范

核心概念：

1. state 状态
2. Getter是state的计算属性
3. Mutation改变state的方法

使用场景：

1.如果项目涉及到三层或三层以上的组件通信的话，就必须Vuex



#### 使用步骤：

1. 安装vuex

   ```
   npm install vuex
   ```

2. 新建文件`src/store/index.js`,并创建一个store

3. main.js中$store设置到Vue的原型上

#### 页面逻辑重构

1. store里面购物车初始化
2. 添加购物车
3. 添加内置logger插件
4. App切后台，购物车数据存储到storage
5. 购物车列表展示，onHide存逻辑去掉
6. 支付页面取cart和过滤cart
7. 修复购物车为空的提示

> 注意点：state里面数据相当于是全局变量，读操作不要改变state.



## 测试环境与生产环境

1. 测试环境和生产环境的数据不一样
   1. 一般在测试环境开发
   2. 经过冒烟测试后，就提交代码到预发布

2. 生产环境（数据库是同一套）
   1. 预发布
      1. 前端和后端的服务都在这里
      2. 大量的测试-修改 loop
   2. 灰度
      1. 相当于是上线的演习
      2. 需要考虑发布的优先级
   3. 线上
      1. 生产回滚