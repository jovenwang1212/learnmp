# 微信小程序学习第3天

## 每日反馈

1.  老师 vue react 小程序 跟原生中的 key 他们之间有什么区别啊 
   1. 都是数据驱动视图的框架，原理上一样。语法上有区别，但是key值的作用是一致的。
   2. 给key的作用是让数据可预测
2.  老师有时间能讲下小程序云开发吗
3.  啥是冷热启动? 
    1.  冷是指从硬盘读取，断电后不会丢失
    2.  热就是指内存
4.  自调试该怎么回答
5.  实现懒加载的思路
6.  后台管理系统登录权限问题



## 补充说明

1. 脚手架的入口文件只能是.js。一般入口文件都是main.js
   1. pages/目录/main.js文件一定要有，一般不需要改，那么直接copy脚手架生成的。
2. 小程序的pages是独立的，样式不会互相影响
   1. 在mpvue的style里面，不用加scoped
3. 微信开发者工具打开项目只能`导入项目`
4. mpvue创建页面
   1. app.json里面加路径
   2. 创建页面，一般copy改
      1. main.js需要copy
5. npm run start清空`dist/wx`  build/dev_server.js

```js
var rm = require('rimraf')
var chalk = require('chalk')
rm(path.join(config.build.assetsRoot, '*'), err => {
  if (err) throw err
  webpack(webpackConfig, function (err, stats) {
    if (err) throw err
    if (process.env.PLATFORM === 'swan') {
      utils.writeFrameworkinfo()
    }
    process.stdout.write(stats.toString({
      colors: true,
      modules: false,
      children: false,
      chunks: false,
      chunkModules: false
    }) + '\n\n')

    if (stats.hasErrors()) {
      console.log(chalk.red('  Build failed with errors.\n'))
      process.exit(1)
    }

    console.log(chalk.cyan('  Build complete.\n'))
    console.log(chalk.yellow(
      '  Tip: built files are meant to be served over an HTTP server.\n' +
      '  Opening index.html over file:// won\'t work.\n'
    ))
  })
})
```



## ESLint说明

 [传送门](https://eslint.bootcss.com/)

1. 是什么？ESLint是JavaScript的检查工具
2. 有什么用？ 一般用于代码规范。
3. 如何使用？一般和webpack配合，执行npm命令，eslint会读到工程下的` .eslintrc `文件里面的规则
   1. 检查代码，如果不符合规范的话，就报错。

#### mpvue项目里面的eslint

1. build/webpackpack.base.conf.js里面配置了eslint-loader，会检查.js和.vue文件的代码格式
2. `eslintrc`里面`extends`声明了代码规范，代码规范是规则集合
   
3. [JavaScript标准代码规范](https://github.com/standard/standard/blob/master/docs/RULES-zhcn.md)

#### vscode自动格式化代码

1. vscode安装插件`prettier`、 Beautify和`eslint`

   ![1573608436109](C:\Users\panliang\Desktop\learnmp\day03\01-教学资料\微信小程序03-上课.assets\1573608436109.png)

   ![1573608442548](C:\Users\panliang\Desktop\learnmp\day03\01-教学资料\微信小程序03-上课.assets\1573608442548.png)

   ![1573608447563](C:\Users\panliang\Desktop\learnmp\day03\01-教学资料\微信小程序03-上课.assets\1573608447563.png)

2. 全局安装eslint

   1. npm install  -g eslint

3. 文件-首选项-设置-打开json，**追加**

   1. **最好先备份一下setting.json**

   ```json
     "editor.tabSize": 2, //制表符符号eslint
     "editor.formatOnSave": false, //每次保存自动格式化
     "eslint.autoFixOnSave": true, // 每次保存的时候将代码按eslint格式进行修复
     "prettier.eslintIntegration": true, //让prettier使用eslint的代码格式进行校验
     "prettier.semi": false, //去掉代码结尾的分号
     "prettier.singleQuote": true, //使用带引号替代双引号
     "javascript.format.insertSpaceBeforeFunctionParenthesis": true, //让函数(名)和后面的括号之间加个空格
     "vetur.format.defaultFormatter.html": "js-beautify-html", //格式化.vue中html
     "vetur.format.defaultFormatter.js": "vscode-typescript", //让vue中的js按编辑器自带的ts格式进行格式化
     "vetur.format.defaultFormatterOptions": {
       "js-beautify-html": {
         "wrap_attributes": "force-aligned" //属性强制折行对齐
       }
     },
     "eslint.validate": [
       //开启对.vue文件中错误的检查
       "javascript",
       "javascriptreact",
       {
         "language": "html",
         "autoFix": true
       },
       {
         "language": "vue",
         "autoFix": true
       }
     ]
   ```

#### 注意点

1. 自动化格式化工具不一定很完美，建议在理解规则的基础上手动改

2. 如果影响写代码，学习阶段还是可以关掉文件的eslint检查，或者全局去掉eslint-loader

   ```js
   /* eslint-disable */
   ```

> .editorconfig也是声明代码规范的文件，需要安装对应的插件生效。没有eslint那么强大，忽略。



## 自适应单位rpx 

[传送门](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html#%E5%B0%BA%E5%AF%B8%E5%8D%95%E4%BD%8D)

1. 所有设备的宽度都是750rpx。相当于所有设备的宽度750等分，每一份是1rpx

2. 开发微信小程序时设计师可以用 iPhone6 作为视觉稿的标准，宽度是750px

   1. **代码里面的元素rpx值=设计稿对应元素的像素值**

3. 需要随屏幕尺寸变化的元素用rpx, 否则用px。官方建议font-size用px

   1. 实际项目里面，哪些元素是固定尺寸的，看实际情况
   
   ```html
   <view class="box">
   </view>
   <view class="rbox">
   </view>
   
   <image src="http://ossweb-img.qq.com/images/lol/web201310/skin/big497004.jpg"></image>
   ```

4. 实际开发中，一般只需要用rpx适配好iphone6就行。



## 异步请求wx.request

[传送门](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html)

基本XMLHttpRequest封装的

> 豆瓣API :   https://api.douban.com/v2/movie/in_theaters?apikey=0df993c66c0c636e29ecbb5344252a4a

使用方法基本和$.ajax一样

```js
wx.request({
    url: 'https://api.douban.com/v2/movie/in_theaters',
    method: 'GET',
    data: {
        apikey: '0df993c66c0c636e29ecbb5344252a4a'
    },
    // 看实际情况是否需要写content-type
    header: {
        'Content-Type': 'application/x-www-form-urlencoded'
    },
    dataType: 'json',
    success: res => {
        console.log(res)
    }
})
```



看实际情况是否需要写content-type

```js
header: {
  'Content-Type': 'application/x-www-form-urlencoded' // 默认值
}
```



## 设置合法域名

[传送门](https://developers.weixin.qq.com/miniprogram/dev/framework/ability/network.html)

小程序里面请求的后端服务器，需要在小程序后台注册域名

服务器域名请在 「小程序后台-开发-开发设置-服务器域名」 中进行配置

> 微信小程序在开发的时候，可以通过勾选不检验合法域名来解决域名安全的问题，但是上线前一定需要配置合法域名。



### 项目开发流程

1. ##### 产品提出需求
   
   1. 产品老大给出产品方向，产品通过数据，提出新增或者优化的需求
   2. 内部跟他的上级过需求，找UI沟通需求设计，找研发沟通是否能实现
   3. 输出tapd及原型图（sketch或者axure画）
      1. 禅道
      2. [优购商城首页](https://www.tapd.cn/40265313/prong/stories/view/1140265313001000011)
   4. 设计人力足够的话，可能给出了设计稿
   
2. ##### 需求答疑

   1. 每周的需求会议安排在周五下午
   2. 研发、测试、产品过一下产品数据，包括上周上线的需求及需求数据
      1. 作为研发也要了解自己的产品
   3. 关于具体的需求，产品给研发后端和前端及测试需求答疑
   4. 需求有设计的疑问的话，设计也会参与
   5. 确定啥时候给设计图、开发人员、上线时候、外部支持，研发SE

3. ##### 前端开发

   1. 跟产品、后端、UI进一步沟通需求。并不是上来就写代码的。沟通需求的时间至少占到整个开发时间的1/3。确定UI设计稿给的时间、哪些接口及接口文档、是否需要外部支持、与后端联调时间、发测试环境上线，上线时间。
   2. 先开发静态页面，后端接口没有完成的情况下，模拟数据来开发。
      1. fildder配置假数据
   3. 联调时，需要后端接口自测能走通。ajax请求，拿数据渲染。
   4. 发布测试环境，测试一般会给几个冒烟测试用例，需要自测通过
   5. 发Code Review
      1. 发pull request

4. ##### 上线流程

   1. 预发布环境
      1.  测试提bug->修bug->提bug  循环
      2. 做好code review
      3. 产品体验
      4. 设计校验
   2. 灰度环境
      1. 预发布ok，**确定发布顺序，回滚策略**，再推灰度
      2. 推灰度有部分用户可以线上访问到，看项目需要，有时候需要在灰度停留一段时间观察
   3. 线上环境
      1. 灰度验证ok,推线上

>代码发布到线上的过程，需要先发布到预发布环境，再到灰度环境，逐步验证没问题，最后才推送到线上环境。
>
>一般在预发布环境，会做以下事情
>
>1. 测试提出bug，前端修改bug，接口问题，前端还得找后端配合解决bug。而后测试再测试提出bug，解决bug，如此循环，直至所有的bug都修复了。
>2. 可以同步进行Code Review(git上提Pull Request, 一般交给组长或者前端同事检查代码)，如果代码有问题，修复
>3. bug修复完后，可以相关的设计来做视觉还原，看看前端页面是否和设计稿一致。如果不一致，修改。
>4. 视觉校验完，进入产品体验环节，产品检验各页面的设计和交互是否和自己预期的一致。如果不一致，修改。
>5. 以上都ok的话，就要确定发布顺序，包括前端配置、js、css、html的发布顺序，及后端的发布顺序。另外要考虑万一发布到灰度有问题的话，如果回滚，也就是怎么让灰度回到发布前。
>
>灰度环境，有部分用户可以访问到的
>
>1. 预发布环环境准备充分后就可以推灰度了。
>2. 灰度环境上，依然需要测试，测试提bug，修bug，直到bug修复完全。
>3. 看项目需要，有时候需要在灰度停留一段时间观察
>4. 如果在发布过程中，发布顺序或者回滚策略有问题的话，需要作调整
>
>线上环境
>
>​	1. 灰度验证ok，推线上。
>
>

## 豆瓣电影案例

<img src="C:\Users\panliang\Desktop\learnmp\day03\01-教学资料\微信小程序03-备课.assets\1571968112685.png" alt="1571968112685" style="zoom: 50%;" />

<img src="C:\Users\panliang\Desktop\learnmp\day03\01-教学资料\微信小程序03-备课.assets\1571968138995.png" alt="1571968138995" style="zoom:50%;" />

#### 01.案例介绍

1. 模仿 https://m.douban.com/movie/ 
2. [豆瓣电影API](https://github.com/jovenwang1212/testApi/blob/master/README.md)
3. 需求
   1. 首页展示影院热映列表和top250列表，列表以横向滚动的形式展示
   2. 点击影院热映和top250的更多，跳转到列表页，以列表的形式展示
4. 设计图

#### 02.创建项目&导入微信开发者工具

1. mpvue创建项目
   1. vue init mpvue/mpvue-quickstart mpvue-douban39
2. git管理
   1. master分支的代码应该和线上一致
   2. git stash -u 存档
   3. git stash pop 恢复存档
   4. 创建分支 git checkout b Fea_joven_20191030
   5. 作业：开发分支上做了修改后，merge到master分支上
  3. npm安装第三方包
         1. 安装错误 
              1. 删除掉node_modules
              2. cmd以管理员身份运行 npm install
  4. 运行项目
  5. 导入项目到微信开发者工具1

#### 03.准备工作

1. 在app.json添加一个新的页面路径 pages/home/main，删掉tabar的配置
2. pages文件夹下复制一份home, 删除掉index,logs文件夹
3. App.vue删掉，生成基本结构即可，去掉template
4. pages/home/index.vue，保留基本结构和文本
5. 安装less和less-loader
6. dev-server.js加入清空dist/wx目录的逻辑

#### 04.静态页面

1. 头部样式
2. 影院热映
   1. scroll-view组件的使用

##### 注意点：

scroll-view横向滚动，需要让scroll-view里的子元素在一行展示

1. 父元素设置 white-space: nowrap; //不换行  
2. 子元素设置display: inline-block;
3. less写样式时，尽量控制层数在3~4

#### 05.影院热映数据渲染

1. wx.request请求

   1. 接口 https://api.douban.com/v2/movie/in_theaters?apikey=0df993c66c0c636e29ecbb5344252a4a
   2. content-type

2. 评分为0展示“暂无评论”

   

#### 06.评分

1. 完成星星的静态结构
   1. 规则
      1. 分数0          暂无评分
      2. 分数0~2       0~1	1星 + 4灰星
      3. 分数:2~4     1-2     2星 + 3灰星
      4. 分数:4~6      2-3    3星 + 2灰星
      5. 分数:6~8    3-4     4星 + 1灰星
      6. 分数:>8       >4    5星 + 0灰星
2. 根据rating.average,也就是评分来展示星星

> mpvue的结构里面不能使用方法。

#### 07.top250电影数据渲染

2. copy结构
2. copy数据请求与渲染

#### 08.影院热映和top250逻辑优化

1. 声明categoryList

   ```js
   categoryList: [
       {
           name: '影院热映',
           param: 'in_theaters',
           list: []
       },
       {
           name: 'top250',
           param: 'top250',
           list: []
       }
   ]
   ```

2. 重构公共请求函数getMovies

3. 渲染影院热映和top250列表



## 移动端自适应方案-rem+flexible.js

[flexible.js](https://github.com/amfe/lib-flexible)

原理

1. flexible.js根据不同屏幕宽度和dpr给html标签设置一个合适的font-size

2. 样式里面我们使用rem，就可以根据不同的font-size得到对应高度,,宽度,margin,padding的值，于是就自适应了。

   

1. rem的概念:  当使用 rem 单位，他们转化为像素大小取决于页根元素的字体大小，即 html 元素的字体大小。 根元素字体大小乘以你 rem 值 
   
1.  根元素的字体大小 16px，10rem 将等同于 160px，即 10 x 16 = 160 
   
1. iphone6，font-size:37.5px, 1rem=37.5px, 100px=100/37.5=2.67rem
2. 200/2/37.5rem=200*@p, @p=1/75

![1572509715418](C:\Users\panliang\Desktop\learnmp\day03\01-教学资料\微信小程序03-上课.assets\1572509715418.png)

flexible.js和media query的对比

1. flexible.js是连续的

> html里面默认字体大小是16px,小程序里面也是16px;

## vscode小程序插件

![1572490153462](C:\Users\panliang\Desktop\learnmp\day03\01-教学资料\微信小程序03-上课.assets\1572490153462.png)